<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedGemma Trauma Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container { max-width: 960px; margin: 0 auto; padding: 40px 20px; }

        header { text-align: center; margin-bottom: 40px; }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle { color: #8892b0; font-size: 1rem; }

        .model-badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 600;
        }

        /* Upload section */
        .upload-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            border: 2px dashed rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .upload-section:hover { border-color: #00d4ff; background: rgba(255,255,255,0.08); }
        .upload-icon { font-size: 3.5rem; margin-bottom: 15px; }

        .upload-btn {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            color: white;
            padding: 13px 35px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            margin-top: 18px;
            display: inline-block;
            transition: transform 0.2s;
        }

        .upload-btn:hover { transform: scale(1.04); }
        input[type="file"] { display: none; }

        /* Vitals panel */
        .vitals-panel {
            margin-top: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            overflow: hidden;
        }

        .vitals-panel summary {
            padding: 12px 18px;
            cursor: pointer;
            color: #00d4ff;
            font-size: 0.9rem;
            font-weight: 600;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vitals-panel summary::-webkit-details-marker { display: none; }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 15px 18px 18px;
        }

        .vitals-grid label {
            display: block;
            font-size: 0.78rem;
            color: #8892b0;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vitals-input {
            width: 100%;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 9px 12px;
            color: #fff;
            font-size: 0.95rem;
        }

        .vitals-input::placeholder { color: #555; }
        .vitals-input:focus { outline: none; border-color: #00d4ff; }

        /* Loading */
        .loading { display: none; text-align: center; padding: 40px; }

        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-steps { color: #8892b0; font-size: 0.9rem; margin-top: 10px; }

        /* Results */
        .results { display: none; margin-top: 40px; }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }

        .result-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 22px;
        }

        .result-card h3 {
            color: #00d4ff;
            margin-bottom: 14px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat { display: flex; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .stat:last-child { border-bottom: none; }
        .stat-value { font-weight: 600; font-size: 1.1rem; }

        .risk-low { color: #00ff88; }
        .risk-moderate { color: #ffaa00; }
        .risk-high { color: #ff4444; }

        .severity-none { color: #8892b0; }
        .severity-mild { color: #00ff88; }
        .severity-moderate { color: #ffaa00; }
        .severity-severe { color: #ff4444; }
        .severity-unknown { color: #8892b0; }

        .report-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 18px;
            font-family: monospace;
            white-space: pre-wrap;
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.7;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Triage badges */
        .triage-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .slice-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .slice-badge-normal { background: rgba(0, 255, 136, 0.12); color: #00ff88; border: 1px solid rgba(0,255,136,0.3); }
        .slice-badge-suspicious { background: rgba(255, 68, 68, 0.12); color: #ff4444; border: 1px solid rgba(255,68,68,0.3); }

        /* Q&A chat */
        .qa-panel {
            display: none;
            margin-top: 30px;
            background: rgba(255,255,255,0.04);
            border-radius: 18px;
            padding: 28px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .qa-panel h3 {
            color: #00d4ff;
            margin-bottom: 18px;
            font-size: 1rem;
        }

        .chat-history {
            background: rgba(0,0,0,0.25);
            border-radius: 10px;
            padding: 16px;
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 16px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .chat-msg { margin-bottom: 14px; }
        .chat-role { font-weight: 700; margin-bottom: 3px; }
        .chat-role-user { color: #7b2ff7; }
        .chat-role-ai { color: #00d4ff; }
        .chat-text { color: #ccd6f6; }

        .qa-input-row { display: flex; gap: 10px; }

        .qa-input {
            flex: 1;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 25px;
            padding: 12px 20px;
            color: #fff;
            font-size: 0.95rem;
        }

        .qa-input::placeholder { color: #555; }
        .qa-input:focus { outline: none; border-color: #00d4ff; }

        .qa-btn {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .qa-btn:hover { opacity: 0.9; }
        .qa-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Differential diagnoses */
        .diff-list { list-style: none; }
        .diff-list li { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 0.9rem; color: #ccd6f6; }
        .diff-list li:last-child { border-bottom: none; }
        .diff-list li::before { content: "â†’ "; color: #7b2ff7; }

        .footer { text-align: center; margin-top: 60px; color: #555; font-size: 0.85rem; }

        @media (max-width: 600px) {
            .results-grid { grid-template-columns: 1fr; }
            .vitals-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>MedGemma Trauma Analysis</h1>
        <p class="subtitle">AI-Powered CT Hemorrhage Detection &amp; Clinical Reasoning</p>
        <div class="model-badges">
            <span class="badge">MedSigLIP-448 Triage</span>
            <span class="badge">MedGemma 1.5 4B Vision</span>
            <span class="badge">U-Net Quantification</span>
            <span class="badge">EAST Guidelines</span>
        </div>
    </header>

    <!-- Upload section -->
    <div class="upload-section" id="uploadSection">
        <div class="upload-icon">ðŸ“¤</div>
        <h2>Upload CT Slices</h2>
        <p style="color:#8892b0; margin-top:10px; font-size:0.9rem;">
            Drag &amp; drop or select one or more CT angiogram slice images (PNG/JPG)
        </p>
        <label class="upload-btn">
            Choose Files
            <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg" multiple>
        </label>

        <!-- Optional vitals -->
        <details class="vitals-panel" id="vitalsPanel">
            <summary>+ Add Patient Vitals (Optional â€” improves clinical reasoning)</summary>
            <div class="vitals-grid">
                <div>
                    <label>Heart Rate (bpm)</label>
                    <input type="number" id="vitHR" class="vitals-input" placeholder="e.g. 110">
                </div>
                <div>
                    <label>Blood Pressure</label>
                    <input type="text" id="vitBP" class="vitals-input" placeholder="e.g. 90/60">
                </div>
                <div>
                    <label>GCS Score (3â€“15)</label>
                    <input type="number" id="vitGCS" class="vitals-input" placeholder="e.g. 14" min="3" max="15">
                </div>
            </div>
        </details>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Running multi-model analysis...</p>
        <div class="loading-steps" id="loadingSteps">
            MedSigLIP triage â†’ MedGemma 1.5 visual analysis â†’ U-Net quantification â†’ Report synthesis
        </div>
    </div>

    <!-- Results -->
    <div class="results" id="results">
        <h2 style="text-align:center; margin-bottom:5px;">Analysis Complete</h2>
        <p style="text-align:center; color:#8892b0; font-size:0.85rem;" id="patientIdDisplay"></p>

        <div class="results-grid">

            <!-- Triage results â€” full width -->
            <div class="result-card" style="grid-column: 1 / -1;">
                <h3>MedSigLIP-448 Triage</h3>
                <div class="triage-badges" id="triageBadges"></div>
                <p style="color:#8892b0; font-size:0.82rem; margin-top:10px;" id="triageSummary"></p>
            </div>

            <!-- Hemorrhage quantification -->
            <div class="result-card">
                <h3>U-Net Quantification</h3>
                <div class="stat">
                    <span>Volume</span>
                    <span class="stat-value" id="volume">--</span>
                </div>
                <div class="stat">
                    <span>Risk Level</span>
                    <span class="stat-value" id="risk">--</span>
                </div>
                <div class="stat">
                    <span>Segmented Voxels</span>
                    <span class="stat-value" id="pixels">--</span>
                </div>
            </div>

            <!-- Visual findings from MedGemma -->
            <div class="result-card">
                <h3>MedGemma 1.5 Findings</h3>
                <div class="stat">
                    <span>Severity</span>
                    <span class="stat-value" id="severity">--</span>
                </div>
                <div class="stat" style="display:block;">
                    <div style="margin-bottom:5px;">Organs</div>
                    <div id="organs" style="color:#ccd6f6; font-size:0.9rem;">--</div>
                </div>
                <div class="stat" style="display:block;">
                    <div style="margin-bottom:5px;">Pattern</div>
                    <div id="injuryPattern" style="color:#ccd6f6; font-size:0.9rem; line-height:1.4;">--</div>
                </div>
            </div>

            <!-- Differential diagnosis -->
            <div class="result-card">
                <h3>Differential Diagnosis</h3>
                <ul class="diff-list" id="diffList">
                    <li>--</li>
                </ul>
            </div>

            <!-- EAST recommendation -->
            <div class="result-card">
                <h3>EAST Recommendation</h3>
                <p id="recommendation" style="font-size:0.9rem; line-height:1.6; color:#ccd6f6;">--</p>
            </div>

            <!-- Full MedGemma report â€” full width -->
            <div class="result-card" style="grid-column: 1 / -1;">
                <h3>MedGemma 1.5 Clinical Report</h3>
                <div class="report-box" id="llmReport">--</div>
            </div>

        </div>

        <div style="text-align:center; margin-top:30px;">
            <button class="upload-btn" onclick="resetApp()">Analyze Another Scan</button>
        </div>
    </div>

    <!-- Q&A chat panel (shown after results) -->
    <div class="qa-panel" id="qaPanel">
        <h3>Ask a Follow-Up Question</h3>
        <p style="color:#8892b0; font-size:0.82rem; margin-bottom:16px;">
            Ask the AI about this scan â€” treatment options, injury mechanism, guideline details, next steps.
        </p>
        <div class="chat-history" id="chatHistory"></div>
        <div class="qa-input-row">
            <input type="text" class="qa-input" id="qaInput"
                   placeholder="e.g. Is surgical intervention indicated given these findings?">
            <button class="qa-btn" id="qaSubmit" onclick="submitQuestion()">Ask</button>
        </div>
    </div>

    <div class="footer">
        <p>MedGemma 1.5 + MedSigLIP-448 | Google HAI-DEF Hackathon 2026</p>
    </div>
</div>

<script>
    // ---------------------------------------------------------------------------
    // State
    // ---------------------------------------------------------------------------
    let currentSessionId = null;
    let qaStreaming = false;

    const fileInput     = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const loading       = document.getElementById('loading');
    const resultsDiv    = document.getElementById('results');
    const qaPanel       = document.getElementById('qaPanel');

    // ---------------------------------------------------------------------------
    // File input trigger
    // ---------------------------------------------------------------------------
    fileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        await runAnalysis(files);
    });

    async function runAnalysis(files) {
        uploadSection.style.display = 'none';
        loading.style.display = 'block';

        const formData = new FormData();
        Array.from(files).forEach(f => formData.append('files', f));

        // Optional vitals
        const hr  = document.getElementById('vitHR').value.trim();
        const bp  = document.getElementById('vitBP').value.trim();
        const gcs = document.getElementById('vitGCS').value.trim();
        if (hr)  formData.append('hr', hr);
        if (bp)  formData.append('bp', bp);
        if (gcs) formData.append('gcs', gcs);

        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.success) {
                showResults(data.result);
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
                resetApp();
            }
        } catch (err) {
            alert('Network error. Is the server running?');
            resetApp();
        }
    }

    // ---------------------------------------------------------------------------
    // Show results
    // ---------------------------------------------------------------------------
    function showResults(result) {
        loading.style.display = 'none';
        resultsDiv.style.display = 'block';
        qaPanel.style.display = 'block';

        currentSessionId = result.session_id;
        document.getElementById('chatHistory').innerHTML = '';

        // Patient ID
        if (result.patient_id) {
            document.getElementById('patientIdDisplay').textContent = 'Patient: ' + result.patient_id;
        }

        // --- Triage badges ---
        const badgesDiv = document.getElementById('triageBadges');
        badgesDiv.innerHTML = '';
        const scores = result.triage.per_slice_scores || [];
        scores.forEach((score, i) => {
            const badge = document.createElement('span');
            const pct = Math.round(score * 100);
            const suspicious = score >= 0.25;
            badge.className = 'slice-badge ' + (suspicious ? 'slice-badge-suspicious' : 'slice-badge-normal');
            badge.textContent = `Slice ${i + 1}: ${pct}%`;
            badge.title = suspicious ? 'Flagged suspicious' : 'Normal';
            badgesDiv.appendChild(badge);
        });
        document.getElementById('triageSummary').textContent =
            `${result.triage.suspicious_slices} of ${result.triage.total_slices} slice(s) flagged â€” ` +
            `max score ${Math.round(result.triage.max_score * 100)}%`;

        // --- U-Net quantification ---
        const quant = result.quantification || {};
        document.getElementById('volume').textContent = (quant.volume_ml || 0).toFixed(2) + ' mL';
        document.getElementById('pixels').textContent = (quant.num_voxels || 0).toLocaleString();

        const riskEl = document.getElementById('risk');
        const risk = (quant.risk_level || 'UNKNOWN').toUpperCase();
        riskEl.textContent = risk;
        riskEl.className = 'stat-value risk-' + risk.toLowerCase();

        // --- MedGemma visual findings ---
        const vf = result.visual_findings || {};

        const sev = (vf.severity_estimate || 'unknown').toLowerCase();
        const sevEl = document.getElementById('severity');
        sevEl.textContent = vf.severity_estimate || '--';
        sevEl.className = 'stat-value severity-' + sev;

        const organs = vf.organs_involved || [];
        document.getElementById('organs').textContent = organs.length ? organs.join(', ') : 'None identified';
        document.getElementById('injuryPattern').textContent = vf.injury_pattern || '--';

        // Differential diagnoses
        const diffList = document.getElementById('diffList');
        diffList.innerHTML = '';
        const diffs = vf.differential_diagnosis || [];
        if (diffs.length) {
            diffs.forEach(d => {
                const li = document.createElement('li');
                li.textContent = d;
                diffList.appendChild(li);
            });
        } else {
            diffList.innerHTML = '<li>Not available</li>';
        }

        // EAST recommendation
        document.getElementById('recommendation').textContent =
            quant.recommendation || 'See full report below.';

        // Full report
        document.getElementById('llmReport').textContent = result.report || '--';

        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ---------------------------------------------------------------------------
    // Q&A streaming
    // ---------------------------------------------------------------------------
    function submitQuestion() {
        if (qaStreaming) return;
        const q = document.getElementById('qaInput').value.trim();
        if (!q) return;
        if (!currentSessionId) { alert('No active session. Please upload a scan first.'); return; }

        document.getElementById('qaInput').value = '';
        appendChatMsg('You', q, 'user');

        const aiMsgEl = appendChatMsg('AI', '', 'ai');
        document.getElementById('qaSubmit').disabled = true;
        qaStreaming = true;

        const url = '/qa-stream?session_id=' + encodeURIComponent(currentSessionId)
                  + '&q=' + encodeURIComponent(q);

        const evtSource = new EventSource(url);
        evtSource.onmessage = (e) => {
            if (e.data === '[DONE]') {
                evtSource.close();
                document.getElementById('qaSubmit').disabled = false;
                qaStreaming = false;
                return;
            }
            aiMsgEl.textContent += e.data;
            // Auto-scroll chat
            const history = document.getElementById('chatHistory');
            history.scrollTop = history.scrollHeight;
        };
        evtSource.onerror = () => {
            evtSource.close();
            document.getElementById('qaSubmit').disabled = false;
            qaStreaming = false;
        };
    }

    function appendChatMsg(role, text, type) {
        const history = document.getElementById('chatHistory');
        const div = document.createElement('div');
        div.className = 'chat-msg';
        const roleEl = document.createElement('div');
        roleEl.className = 'chat-role chat-role-' + type;
        roleEl.textContent = role;
        const textEl = document.createElement('div');
        textEl.className = 'chat-text';
        textEl.textContent = text;
        div.appendChild(roleEl);
        div.appendChild(textEl);
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
        return textEl;  // Return text element for streaming updates
    }

    // Enter key submits Q&A
    document.getElementById('qaInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitQuestion(); }
    });

    // ---------------------------------------------------------------------------
    // Reset
    // ---------------------------------------------------------------------------
    function resetApp() {
        fileInput.value = '';
        currentSessionId = null;
        uploadSection.style.display = 'block';
        loading.style.display = 'none';
        resultsDiv.style.display = 'none';
        qaPanel.style.display = 'none';
        document.getElementById('chatHistory').innerHTML = '';
    }

    // ---------------------------------------------------------------------------
    // Drag and drop
    // ---------------------------------------------------------------------------
    uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.style.borderColor = '#00d4ff';
    });

    uploadSection.addEventListener('dragleave', () => {
        uploadSection.style.borderColor = 'rgba(255,255,255,0.1)';
    });

    uploadSection.addEventListener('drop', async (e) => {
        e.preventDefault();
        uploadSection.style.borderColor = 'rgba(255,255,255,0.1)';
        const files = e.dataTransfer.files;
        if (files.length > 0) await runAnalysis(files);
    });
</script>
</body>
</html>
